name: aws-oidc-claims
on:
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  show-claims:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Print OIDC iss/aud/sub (Python, self-contained)
        shell: bash
        run: |
          python - <<'PY'
          import os, json, base64, urllib.request, urllib.error

          print("Requesting GitHub OIDC token…")
          req_url = os.environ['ACTIONS_ID_TOKEN_REQUEST_URL'] + "&audience=sts.amazonaws.com"
          req_tok = os.environ['ACTIONS_ID_TOKEN_REQUEST_TOKEN']

          req = urllib.request.Request(req_url, headers={"Authorization": f"Bearer {req_tok}"})
          try:
              with urllib.request.urlopen(req) as r:
                  resp = json.loads(r.read().decode('utf-8'))
          except urllib.error.HTTPError as e:
              raise SystemExit(f"Failed to get OIDC token: {e} {e.read().decode('utf-8','ignore')}")

          id_token = resp.get("value")
          if not id_token:
              raise SystemExit("No 'value' field in OIDC response")

          print("OIDC token acquired. Decoding payload…")
          try:
              _, pl_b64, _ = id_token.split(".")
              pl_b64 += "=" * (-len(pl_b64) % 4)  # restore padding
              payload = json.loads(base64.urlsafe_b64decode(pl_b64.encode('utf-8')).decode('utf-8'))
          except Exception as e:
              raise SystemExit(f"Decode error: {e}")

          print(json.dumps({k: payload.get(k) for k in ("iss","aud","sub")}, indent=2))
          PY