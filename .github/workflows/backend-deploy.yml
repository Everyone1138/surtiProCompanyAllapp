name: Deploy Backend (OrgJet)

on:
  push:
    branches: [ "main" ]
    paths:
      - "orgjet-backend/**"
      - ".github/workflows/backend-deploy.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write

env:
  AWS_REGION: us-east-1
  CLUSTER_NAME: orgjet
  SERVICE_NAME: orgjet-backend-svc
  ECR_REPO: orgjet-backend
  GHCR_IMAGE: orgjet-backend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner
        run: echo "OWNER_LC=${OWNER_LC}" >> $GITHUB_ENV
        env:
          OWNER_LC: ${{ toLower(github.repository_owner) }}

      - name: Set image refs
        run: |
          echo "GHCR_REF=ghcr.io/${OWNER_LC}/${GHCR_IMAGE}:sha-${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Set up Docker Buildx (docker-container)
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push to GHCR
        uses: docker/build-push-action@v6
        with:
          context: ./orgjet-backend
          file: ./orgjet-backend/Dockerfile
          push: true
          tags: ${{ env.GHCR_REF }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Configure AWS credentials (OIDC)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure AWS credentials (static fallback)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        run: |
          ACCOUNT_ID="$(aws sts get-caller-identity --query Account --output text)"
          echo "ACCOUNT_ID=$ACCOUNT_ID" >> $GITHUB_ENV
          aws ecr get-login-password --region "${AWS_REGION}" \
            | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"

      - name: Promote GHCR -> ECR (:latest)
        run: |
          ECR_REF="${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:latest"
          echo "ECR_REF=$ECR_REF" >> $GITHUB_ENV
          docker pull "${GHCR_REF}"
          docker tag "${GHCR_REF}" "${ECR_REF}"
          docker push "${ECR_REF}"

      - name: Update ECS task definition and force deploy
        run: |
          set -euo pipefail

          TASKDEF_ARN="$(aws ecs describe-services \
            --cluster "${CLUSTER_NAME}" \
            --services "${SERVICE_NAME}" \
            --query 'services[0].taskDefinition' \
            --output text)"

          CONTAINER_NAME="$(aws ecs describe-task-definition \
            --task-definition "${TASKDEF_ARN}" \
            --query 'taskDefinition.containerDefinitions[0].name' \
            --output text)"

          aws ecs describe-task-definition \
            --task-definition "${TASKDEF_ARN}" \
            --query 'taskDefinition' \
            --output json \
          | jq --arg IMG "${ECR_REF}" --arg CNAME "${CONTAINER_NAME}" '
              del(.taskDefinitionArn,.revision,.status,.requiresAttributes,.compatibilities,.registeredAt,.registeredBy)
              | .containerDefinitions = (.containerDefinitions | map(if .name == $CNAME then .image = $IMG else . end))
            ' > new-taskdef.json

          NEW_TASKDEF_ARN="$(aws ecs register-task-definition \
            --cli-input-json file://new-taskdef.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)"

          aws ecs update-service \
            --cluster "${CLUSTER_NAME}" \
            --service "${SERVICE_NAME}" \
            --task-definition "${NEW_TASKDEF_ARN}" \
            --force-new-deployment

          echo "Deployed backend taskdef: ${NEW_TASKDEF_ARN}"
